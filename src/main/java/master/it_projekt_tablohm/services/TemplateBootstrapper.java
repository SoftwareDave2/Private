package master.it_projekt_tablohm.services;

import master.it_projekt_tablohm.dto.TemplateDefinitionDTO;
import master.it_projekt_tablohm.models.TemplateType;
import master.it_projekt_tablohm.repositories.DisplayTemplateRepository;
import master.it_projekt_tablohm.repositories.TemplateTypeRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.CommandLineRunner;
import org.springframework.stereotype.Component;

import java.util.List;

@Component
public class TemplateBootstrapper implements CommandLineRunner {

    private static final Logger logger = LoggerFactory.getLogger(TemplateBootstrapper.class);

    private final DisplayTemplateRepository templateRepository;
    private final TemplateManagementService templateManagementService;
    private final TemplateTypeRepository templateTypeRepository;

    private final boolean forceOverwrite =
            Boolean.parseBoolean(System.getenv().getOrDefault("TEMPLATE_BOOTSTRAP_OVERWRITE", "false"));


    public TemplateBootstrapper(DisplayTemplateRepository templateRepository,
                                TemplateManagementService templateManagementService,
                                TemplateTypeRepository templateTypeRepository) {
        this.templateRepository = templateRepository;
        this.templateManagementService = templateManagementService;
        this.templateTypeRepository = templateTypeRepository;
    }

    @Override
    public void run(String... args) {
        List<TemplateSeed> seeds = List.of(
                new TemplateSeed(
                        "door-sign",
                        "Türschild Standard",
                        "Standard-Türschild für 400x300 Displays",
                        400,
                        300,
                        """
                                <svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="400" height="300" fill="#ffffff"/>
                                    <text x="20" y="60" font-size="42" fill="#000000">{roomNumber}</text>
                                    <text x="20" y="110" font-size="18" fill="#000000">{footerNote}</text>
                                </svg>
                                """
                ),
                new TemplateSeed(
                        "event-board",
                        "Ereignistafel Standard",
                        "Übersicht für Ereignisse (400x300)",
                        400,
                        300,
                        """
                                <svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="400" height="300" fill="#ffffff"/>
                                    <text x="20" y="40" font-size="28" fill="#000000">{title}</text>
                                    <text x="20" y="70" font-size="16" fill="#000000">{description}</text>
                                </svg>
                                """
                ),
                new TemplateSeed(
                        "notice-board",
                        "Hinweisschild Standard",
                        "Hinweisschild für 296x128 Displays",
                        296,
                        128,
                        """
                                 <svg id="root" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 296 128" width="296" height="128">
                                   <!-- globaler Hintergrund: -->
                                   <rect id="bg" x="0" y="0" width="296" height="128" fill="#ffffff"/>
                                
                                   <!-- Zustand: befüllt -->
                                   <g id="state-filled">
                                     <rect id="headerBar" x="0.071" y="0.355" width="296" height="37.374" fill="#ff0000" />
                                     <text id="headerTitle" x="8.415" y="29.554"
                                           style="fill:#ffffff; font-family: Arial, sans-serif; font-size: 24px">Druckerstatus</text>
                                
                                     <!-- lieber reines Schwarz statt #333 für saubere Palettierung -->
                                     <text id="line1" x="9" y="66"
                                           style="fill:#000000; font-family: Arial, sans-serif; font-size: 16px">Textzeile 1</text>
                                     <text id="line2" x="9" y="93"
                                           style="fill:#000000; font-family: Arial, sans-serif; font-size: 16px">Textzeile 2</text>
                                   </g>
                                
                                   <!-- Zustand: Leerlauf -->
                                   <g id="state-idle" style="display:none">
                                     <rect x="0.071" y="0.355" width="296" height="37.374" style="stroke: rgb(255, 0, 0); fill: rgb(255, 0, 0);"/>
                                         <text style="fill: rgb(255, 255, 255); font-family: Arial, sans-serif; font-size: 28px; white-space: pre;" x="64.476" y="28.386">Hinweisschild</text>
                                         <g id="preview" transform="matrix(1.333696, 0, 0, 1.208561, -400.829291, -33.080102)" style="">
                                           <path d="M 387.432 85.811 L 389.432 85.811 L 389.432 87.811 L 387.432 87.811 L 387.432 85.811 Z M 389.432 85.811 L 391.432 85.811 L 391.432 87.811 L 389.432 87.811 L 389.432 85.811 Z M 391.432 85.811 L 393.432 85.811 L 393.432 87.811 L 391.432 87.811 L 391.432 85.811 Z M 393.432 85.811 L 395.432 85.811 L 395.432 87.811 L 393.432 87.811 L 393.432 85.811 Z M 395.432 85.811 L 397.432 85.811 L 397.432 87.811 L 395.432 87.811 L 395.432 85.811 Z M 397.432 85.811 L 399.432 85.811 L 399.432 87.811 L 397.432 87.811 L 397.432 85.811 Z M 399.432 85.811 L 401.432 85.811 L 401.432 87.811 L 399.432 87.811 L 399.432 85.811 Z M 403.432 85.811 L 405.432 85.811 L 405.432 87.811 L 403.432 87.811 L 403.432 85.811 Z M 405.432 85.811 L 407.432 85.811 L 407.432 87.811 L 405.432 87.811 L 405.432 85.811 Z M 407.432 85.811 L 409.432 85.811 L 409.432 87.811 L 407.432 87.811 L 407.432 85.811 Z M 409.432 85.811 L 411.432 85.811 L 411.432 87.811 L 409.432 87.811 L 409.432 85.811 Z M 411.432 85.811 L 413.432 85.811 L 413.432 87.811 L 411.432 87.811 L 411.432 85.811 Z M 415.432 85.811 L 417.432 85.811 L 417.432 87.811 L 415.432 87.811 L 415.432 85.811 Z M 417.432 85.811 L 419.432 85.811 L 419.432 87.811 L 417.432 87.811 L 417.432 85.811 Z M 419.432 85.811 L 421.432 85.811 L 421.432 87.811 L 419.432 87.811 L 419.432 85.811 Z M 421.432 85.811 L 423.432 85.811 L 423.432 87.811 L 421.432 87.811 L 421.432 85.811 Z M 423.432 85.811 L 425.432 85.811 L 425.432 87.811 L 423.432 87.811 L 423.432 85.811 Z M 425.432 85.811 L 427.432 85.811 L 427.432 87.811 L 425.432 87.811 L 425.432 85.811 Z M 427.432 85.811 L 429.432 85.811 L 429.432 87.811 L 427.432 87.811 L 427.432 85.811 Z M 387.432 87.811 L 389.432 87.811 L 389.432 89.811 L 387.432 89.811 L 387.432 87.811 Z M 399.432 87.811 L 401.432 87.811 L 401.432 89.811 L 399.432 89.811 L 399.432 87.811 Z M 407.432 87.811 L 409.432 87.811 L 409.432 89.811 L 407.432 89.811 L 407.432 87.811 Z M 415.432 87.811 L 417.432 87.811 L 417.432 89.811 L 415.432 89.811 L 415.432 87.811 Z M 427.432 87.811 L 429.432 87.811 L 429.432 89.811 L 427.432 89.811 L 427.432 87.811 Z M 387.432 89.811 L 389.432 89.811 L 389.432 91.811 L 387.432 91.811 L 387.432 89.811 Z M 391.432 89.811 L 393.432 89.811 L 393.432 91.811 L 391.432 91.811 L 391.432 89.811 Z M 393.432 89.811 L 395.432 89.811 L 395.432 91.811 L 393.432 91.811 L 393.432 89.811 Z M 395.432 89.811 L 397.432 89.811 L 397.432 91.811 L 395.432 91.811 L 395.432 89.811 Z M 399.432 89.811 L 401.432 89.811 L 401.432 91.811 L 399.432 91.811 L 399.432 89.811 Z M 405.432 89.811 L 407.432 89.811 L 407.432 91.811 L 405.432 91.811 L 405.432 89.811 Z M 409.432 89.811 L 411.432 89.811 L 411.432 91.811 L 409.432 91.811 L 409.432 89.811 Z M 411.432 89.811 L 413.432 89.811 L 413.432 91.811 L 411.432 91.811 L 411.432 89.811 Z M 415.432 89.811 L 417.432 89.811 L 417.432 91.811 L 415.432 91.811 L 415.432 89.811 Z M 419.432 89.811 L 421.432 89.811 L 421.432 91.811 L 419.432 91.811 L 419.432 89.811 Z M 421.432 89.811 L 423.432 89.811 L 423.432 91.811 L 421.432 91.811 L 421.432 89.811 Z M 423.432 89.811 L 425.432 89.811 L 425.432 91.811 L 423.432 91.811 L 423.432 89.811 Z M 427.432 89.811 L 429.432 89.811 L 429.432 91.811 L 427.432 91.811 L 427.432 89.811 Z M 387.432 91.811 L 389.432 91.811 L 389.432 93.811 L 387.432 93.811 L 387.432 91.811 Z M 391.432 91.811 L 393.432 91.811 L 393.432 93.811 L 391.432 93.811 L 391.432 91.811 Z M 393.432 91.811 L 395.432 91.811 L 395.432 93.811 L 393.432 93.811 L 393.432 91.811 Z M 395.432 91.811 L 397.432 91.811 L 397.432 93.811 L 395.432 93.811 L 395.432 91.811 Z M 399.432 91.811 L 401.432 91.811 L 401.432 93.811 L 399.432 93.811 L 399.432 91.811 Z M 403.432 91.811 L 405.432 91.811 L 405.432 93.811 L 403.432 93.811 L 403.432 91.811 Z M 405.432 91.811 L 407.432 91.811 L 407.432 93.811 L 405.432 93.811 L 405.432 91.811 Z M 411.432 91.811 L 413.432 91.811 L 413.432 93.811 L 411.432 93.811 L 411.432 91.811 Z M 415.432 91.811 L 417.432 91.811 L 417.432 93.811 L 415.432 93.811 L 415.432 91.811 Z M 419.432 91.811 L 421.432 91.811 L 421.432 93.811 L 419.432 93.811 L 419.432 91.811 Z M 421.432 91.811 L 423.432 91.811 L 423.432 93.811 L 421.432 93.811 L 421.432 91.811 Z M 423.432 91.811 L 425.432 91.811 L 425.432 93.811 L 423.432 93.811 L 423.432 91.811 Z M 427.432 91.811 L 429.432 91.811 L 429.432 93.811 L 427.432 93.811 L 427.432 91.811 Z M 387.432 93.811 L 389.432 93.811 L 389.432 95.811 L 387.432 95.811 L 387.432 93.811 Z M 391.432 93.811 L 393.432 93.811 L 393.432 95.811 L 391.432 95.811 L 391.432 93.811 Z M 393.432 93.811 L 395.432 93.811 L 395.432 95.811 L 393.432 95.811 L 393.432 93.811 Z M 395.432 93.811 L 397.432 93.811 L 397.432 95.811 L 395.432 95.811 L 395.432 93.811 Z M 399.432 93.811 L 401.432 93.811 L 401.432 95.811 L 399.432 95.811 L 399.432 93.811 Z M 403.432 93.811 L 405.432 93.811 L 405.432 95.811 L 403.432 95.811 L 403.432 93.811 Z M 409.432 93.811 L 411.432 93.811 L 411.432 95.811 L 409.432 95.811 L 409.432 93.811 Z M 411.432 93.811 L 413.432 93.811 L 413.432 95.811 L 411.432 95.811 L 411.432 93.811 Z M 415.432 93.811 L 417.432 93.811 L 417.432 95.811 L 415.432 95.811 L 415.432 93.811 Z M 419.432 93.811 L 421.432 93.811 L 421.432 95.811 L 419.432 95.811 L 419.432 93.811 Z M 421.432 93.811 L 423.432 93.811 L 423.432 95.811 L 421.432 95.811 L 421.432 93.811 Z M 423.432 93.811 L 425.432 93.811 L 425.432 95.811 L 423.432 95.811 L 423.432 93.811 Z M 427.432 93.811 L 429.432 93.811 L 429.432 95.811 L 427.432 95.811 L 427.432 93.811 Z M 387.432 95.811 L 389.432 95.811 L 389.432 97.811 L 387.432 97.811 L 387.432 95.811 Z M 399.432 95.811 L 401.432 95.811 L 401.432 97.811 L 399.432 97.811 L 399.432 95.811 Z M 403.432 95.811 L 405.432 95.811 L 405.432 97.811 L 403.432 97.811 L 403.432 95.811 Z M 405.432 95.811 L 407.432 95.811 L 407.432 97.811 L 405.432 97.811 L 405.432 95.811 Z M 411.432 95.811 L 413.432 95.811 L 413.432 97.811 L 411.432 97.811 L 411.432 95.811 Z M 415.432 95.811 L 417.432 95.811 L 417.432 97.811 L 415.432 97.811 L 415.432 95.811 Z M 427.432 95.811 L 429.432 95.811 L 429.432 97.811 L 427.432 97.811 L 427.432 95.811 Z M 387.432 97.811 L 389.432 97.811 L 389.432 99.811 L 387.432 99.811 L 387.432 97.811 Z M 389.432 97.811 L 391.432 97.811 L 391.432 99.811 L 389.432 99.811 L 389.432 97.811 Z M 391.432 97.811 L 393.432 97.811 L 393.432 99.811 L 391.432 99.811 L 391.432 97.811 Z M 393.432 97.811 L 395.432 97.811 L 395.432 99.811 L 393.432 99.811 L 393.432 97.811 Z M 395.432 97.811 L 397.432 97.811 L 397.432 99.811 L 395.432 99.811 L 395.432 97.811 Z M 397.432 97.811 L 399.432 97.811 L 399.432 99.811 L 397.432 99.811 L 397.432 97.811 Z M 399.432 97.811 L 401.432 97.811 L 401.432 99.811 L 399.432 99.811 L 399.432 97.811 Z M 403.432 97.811 L 405.432 97.811 L 405.432 99.811 L 403.432 99.811 L 403.432 97.811 Z M 407.432 97.811 L 409.432 97.811 L 409.432 99.811 L 407.432 99.811 L 407.432 97.811 Z M 411.432 97.811 L 413.432 97.811 L 413.432 99.811 L 411.432 99.811 L 411.432 97.811 Z M 415.432 97.811 L 417.432 97.811 L 417.432 99.811 L 415.432 99.811 L 415.432 97.811 Z M 417.432 97.811 L 419.432 97.811 L 419.432 99.811 L 417.432 99.811 L 417.432 97.811 Z M 419.432 97.811 L 421.432 97.811 L 421.432 99.811 L 419.432 99.811 L 419.432 97.811 Z M 421.432 97.811 L 423.432 97.811 L 423.432 99.811 L 421.432 99.811 L 421.432 97.811 Z M 423.432 97.811 L 425.432 97.811 L 425.432 99.811 L 423.432 99.811 L 423.432 97.811 Z M 425.432 97.811 L 427.432 97.811 L 427.432 99.811 L 425.432 99.811 L 425.432 97.811 Z M 427.432 97.811 L 429.432 97.811 L 429.432 99.811 L 427.432 99.811 L 427.432 97.811 Z M 403.432 99.811 L 405.432 99.811 L 405.432 101.811 L 403.432 101.811 L 403.432 99.811 Z M 405.432 99.811 L 407.432 99.811 L 407.432 101.811 L 405.432 101.811 L 405.432 99.811 Z M 387.432 101.811 L 389.432 101.811 L 389.432 103.811 L 387.432 103.811 L 387.432 101.811 Z M 395.432 101.811 L 397.432 101.811 L 397.432 103.811 L 395.432 103.811 L 395.432 101.811 Z M 399.432 101.811 L 401.432 101.811 L 401.432 103.811 L 399.432 103.811 L 399.432 101.811 Z M 401.432 101.811 L 403.432 101.811 L 403.432 103.811 L 401.432 103.811 L 401.432 101.811 Z M 403.432 101.811 L 405.432 101.811 L 405.432 103.811 L 403.432 103.811 L 403.432 101.811 Z M 405.432 101.811 L 407.432 101.811 L 407.432 103.811 L 405.432 103.811 L 405.432 101.811 Z M 407.432 101.811 L 409.432 101.811 L 409.432 103.811 L 407.432 103.811 L 407.432 101.811 Z M 411.432 101.811 L 413.432 101.811 L 413.432 103.811 L 411.432 103.811 L 411.432 101.811 Z M 413.432 101.811 L 415.432 101.811 L 415.432 103.811 L 413.432 103.811 L 413.432 101.811 Z M 415.432 101.811 L 417.432 101.811 L 417.432 103.811 L 415.432 103.811 L 415.432 101.811 Z M 417.432 101.811 L 419.432 101.811 L 419.432 103.811 L 417.432 103.811 L 417.432 101.811 Z M 419.432 101.811 L 421.432 101.811 L 421.432 103.811 L 419.432 103.811 L 419.432 101.811 Z M 421.432 101.811 L 423.432 101.811 L 423.432 103.811 L 421.432 103.811 L 421.432 101.811 Z M 427.432 101.811 L 429.432 101.811 L 429.432 103.811 L 427.432 103.811 L 427.432 101.811 Z M 389.432 103.811 L 391.432 103.811 L 391.432 105.811 L 389.432 105.811 L 389.432 103.811 Z M 391.432 103.811 L 393.432 103.811 L 393.432 105.811 L 391.432 105.811 L 391.432 103.811 Z M 393.432 103.811 L 395.432 103.811 L 395.432 105.811 L 393.432 105.811 L 393.432 103.811 Z M 405.432 103.811 L 407.432 103.811 L 407.432 105.811 L 405.432 105.811 L 405.432 103.811 Z M 411.432 103.811 L 413.432 103.811 L 413.432 105.811 L 411.432 105.811 L 411.432 103.811 Z M 413.432 103.811 L 415.432 103.811 L 415.432 105.811 L 413.432 105.811 L 413.432 103.811 Z M 415.432 103.811 L 417.432 103.811 L 417.432 105.811 L 415.432 105.811 L 415.432 103.811 Z M 421.432 103.811 L 423.432 103.811 L 423.432 105.811 L 421.432 105.811 L 421.432 103.811 Z M 423.432 103.811 L 425.432 103.811 L 425.432 105.811 L 423.432 105.811 L 423.432 103.811 Z M 425.432 103.811 L 427.432 103.811 L 427.432 105.811 L 425.432 105.811 L 425.432 103.811 Z M 389.432 105.811 L 391.432 105.811 L 391.432 107.811 L 389.432 107.811 L 389.432 105.811 Z M 399.432 105.811 L 401.432 105.811 L 401.432 107.811 L 399.432 107.811 L 399.432 105.811 Z M 401.432 105.811 L 403.432 105.811 L 403.432 107.811 L 401.432 107.811 L 401.432 105.811 Z M 405.432 105.811 L 407.432 105.811 L 407.432 107.811 L 405.432 107.811 L 405.432 105.811 Z M 411.432 105.811 L 413.432 105.811 L 413.432 107.811 L 411.432 107.811 L 411.432 105.811 Z M 413.432 105.811 L 415.432 105.811 L 415.432 107.811 L 413.432 107.811 L 413.432 105.811 Z M 425.432 105.811 L 427.432 105.811 L 427.432 107.811 L 425.432 107.811 L 425.432 105.811 Z M 389.432 107.811 L 391.432 107.811 L 391.432 109.811 L 389.432 109.811 L 389.432 107.811 Z M 391.432 107.811 L 393.432 107.811 L 393.432 109.811 L 391.432 109.811 L 391.432 107.811 Z M 393.432 107.811 L 395.432 107.811 L 395.432 109.811 L 393.432 109.811 L 393.432 107.811 Z M 395.432 107.811 L 397.432 107.811 L 397.432 109.811 L 395.432 109.811 L 395.432 107.811 Z M 397.432 107.811 L 399.432 107.811 L 399.432 109.811 L 397.432 109.811 L 397.432 107.811 Z M 401.432 107.811 L 403.432 107.811 L 403.432 109.811 L 401.432 109.811 L 401.432 107.811 Z M 405.432 107.811 L 407.432 107.811 L 407.432 109.811 L 405.432 109.811 L 405.432 107.811 Z M 407.432 107.811 L 409.432 107.811 L 409.432 109.811 L 407.432 109.811 L 407.432 107.811 Z M 409.432 107.811 L 411.432 107.811 L 411.432 109.811 L 409.432 109.811 L 409.432 107.811 Z M 411.432 107.811 L 413.432 107.811 L 413.432 109.811 L 411.432 109.811 L 411.432 107.811 Z M 417.432 107.811 L 419.432 107.811 L 419.432 109.811 L 417.432 109.811 L 417.432 107.811 Z M 387.432 109.811 L 389.432 109.811 L 389.432 111.811 L 387.432 111.811 L 387.432 109.811 Z M 389.432 109.811 L 391.432 109.811 L 391.432 111.811 L 389.432 111.811 L 389.432 109.811 Z M 399.432 109.811 L 401.432 109.811 L 401.432 111.811 L 399.432 111.811 L 399.432 109.811 Z M 401.432 109.811 L 403.432 109.811 L 403.432 111.811 L 401.432 111.811 L 401.432 109.811 Z M 405.432 109.811 L 407.432 109.811 L 407.432 111.811 L 405.432 111.811 L 405.432 109.811 Z M 407.432 109.811 L 409.432 109.811 L 409.432 111.811 L 407.432 111.811 L 407.432 109.811 Z M 409.432 109.811 L 411.432 109.811 L 411.432 111.811 L 409.432 111.811 L 409.432 109.811 Z M 415.432 109.811 L 417.432 109.811 L 417.432 111.811 L 415.432 111.811 L 415.432 109.811 Z M 417.432 109.811 L 419.432 109.811 L 419.432 111.811 L 417.432 111.811 L 417.432 109.811 Z M 419.432 109.811 L 421.432 109.811 L 421.432 111.811 L 419.432 111.811 L 419.432 109.811 Z M 421.432 109.811 L 423.432 109.811 L 423.432 111.811 L 421.432 111.811 L 421.432 109.811 Z M 427.432 109.811 L 429.432 109.811 L 429.432 111.811 L 427.432 111.811 L 427.432 109.811 Z M 403.432 111.811 L 405.432 111.811 L 405.432 113.811 L 403.432 113.811 L 403.432 111.811 Z M 407.432 111.811 L 409.432 111.811 L 409.432 113.811 L 407.432 113.811 L 407.432 111.811 Z M 409.432 111.811 L 411.432 111.811 L 411.432 113.811 L 409.432 113.811 L 409.432 111.811 Z M 411.432 111.811 L 413.432 111.811 L 413.432 113.811 L 411.432 113.811 L 411.432 111.811 Z M 417.432 111.811 L 419.432 111.811 L 419.432 113.811 L 417.432 113.811 L 417.432 111.811 Z M 423.432 111.811 L 425.432 111.811 L 425.432 113.811 L 423.432 113.811 L 423.432 111.811 Z M 427.432 111.811 L 429.432 111.811 L 429.432 113.811 L 427.432 113.811 L 427.432 111.811 Z M 387.432 113.811 L 389.432 113.811 L 389.432 115.811 L 387.432 115.811 L 387.432 113.811 Z M 389.432 113.811 L 391.432 113.811 L 391.432 115.811 L 389.432 115.811 L 389.432 113.811 Z M 391.432 113.811 L 393.432 113.811 L 393.432 115.811 L 391.432 115.811 L 391.432 113.811 Z M 393.432 113.811 L 395.432 113.811 L 395.432 115.811 L 393.432 115.811 L 393.432 113.811 Z M 395.432 113.811 L 397.432 113.811 L 397.432 115.811 L 395.432 115.811 L 395.432 113.811 Z M 397.432 113.811 L 399.432 113.811 L 399.432 115.811 L 397.432 115.811 L 397.432 113.811 Z M 399.432 113.811 L 401.432 113.811 L 401.432 115.811 L 399.432 115.811 L 399.432 113.811 Z M 403.432 113.811 L 405.432 113.811 L 405.432 115.811 L 403.432 115.811 L 403.432 113.811 Z M 409.432 113.811 L 411.432 113.811 L 411.432 115.811 L 409.432 115.811 L 409.432 113.811 Z M 415.432 113.811 L 417.432 113.811 L 417.432 115.811 L 415.432 115.811 L 415.432 113.811 Z M 417.432 113.811 L 419.432 113.811 L 419.432 115.811 L 417.432 115.811 L 417.432 113.811 Z M 419.432 113.811 L 421.432 113.811 L 421.432 115.811 L 419.432 115.811 L 419.432 113.811 Z M 423.432 113.811 L 425.432 113.811 L 425.432 115.811 L 423.432 115.811 L 423.432 113.811 Z M 425.432 113.811 L 427.432 113.811 L 427.432 115.811 L 425.432 115.811 L 425.432 113.811 Z M 387.432 115.811 L 389.432 115.811 L 389.432 117.811 L 387.432 117.811 L 387.432 115.811 Z M 399.432 115.811 L 401.432 115.811 L 401.432 117.811 L 399.432 117.811 L 399.432 115.811 Z M 413.432 115.811 L 415.432 115.811 L 415.432 117.811 L 413.432 117.811 L 413.432 115.811 Z M 415.432 115.811 L 417.432 115.811 L 417.432 117.811 L 415.432 117.811 L 415.432 115.811 Z M 419.432 115.811 L 421.432 115.811 L 421.432 117.811 L 419.432 117.811 L 419.432 115.811 Z M 387.432 117.811 L 389.432 117.811 L 389.432 119.811 L 387.432 119.811 L 387.432 117.811 Z M 391.432 117.811 L 393.432 117.811 L 393.432 119.811 L 391.432 119.811 L 391.432 117.811 Z M 393.432 117.811 L 395.432 117.811 L 395.432 119.811 L 393.432 119.811 L 393.432 117.811 Z M 395.432 117.811 L 397.432 117.811 L 397.432 119.811 L 395.432 119.811 L 395.432 117.811 Z M 399.432 117.811 L 401.432 117.811 L 401.432 119.811 L 399.432 119.811 L 399.432 117.811 Z M 403.432 117.811 L 405.432 117.811 L 405.432 119.811 L 403.432 119.811 L 403.432 117.811 Z M 411.432 117.811 L 413.432 117.811 L 413.432 119.811 L 411.432 119.811 L 411.432 117.811 Z M 413.432 117.811 L 415.432 117.811 L 415.432 119.811 L 413.432 119.811 L 413.432 117.811 Z M 415.432 117.811 L 417.432 117.811 L 417.432 119.811 L 415.432 119.811 L 415.432 117.811 Z M 421.432 117.811 L 423.432 117.811 L 423.432 119.811 L 421.432 119.811 L 421.432 117.811 Z M 427.432 117.811 L 429.432 117.811 L 429.432 119.811 L 427.432 119.811 L 427.432 117.811 Z M 387.432 119.811 L 389.432 119.811 L 389.432 121.811 L 387.432 121.811 L 387.432 119.811 Z M 391.432 119.811 L 393.432 119.811 L 393.432 121.811 L 391.432 121.811 L 391.432 119.811 Z M 393.432 119.811 L 395.432 119.811 L 395.432 121.811 L 393.432 121.811 L 393.432 119.811 Z M 395.432 119.811 L 397.432 119.811 L 397.432 121.811 L 395.432 121.811 L 395.432 119.811 Z M 399.432 119.811 L 401.432 119.811 L 401.432 121.811 L 399.432 121.811 L 399.432 119.811 Z M 405.432 119.811 L 407.432 119.811 L 407.432 121.811 L 405.432 121.811 L 405.432 119.811 Z M 407.432 119.811 L 409.432 119.811 L 409.432 121.811 L 407.432 121.811 L 407.432 119.811 Z M 411.432 119.811 L 413.432 119.811 L 413.432 121.811 L 411.432 121.811 L 411.432 119.811 Z M 413.432 119.811 L 415.432 119.811 L 415.432 121.811 L 413.432 121.811 L 413.432 119.811 Z M 415.432 119.811 L 417.432 119.811 L 417.432 121.811 L 415.432 121.811 L 415.432 119.811 Z M 421.432 119.811 L 423.432 119.811 L 423.432 121.811 L 421.432 121.811 L 421.432 119.811 Z M 423.432 119.811 L 425.432 119.811 L 425.432 121.811 L 423.432 121.811 L 423.432 119.811 Z M 425.432 119.811 L 427.432 119.811 L 427.432 121.811 L 425.432 121.811 L 425.432 119.811 Z M 427.432 119.811 L 429.432 119.811 L 429.432 121.811 L 427.432 121.811 L 427.432 119.811 Z M 387.432 121.811 L 389.432 121.811 L 389.432 123.811 L 387.432 123.811 L 387.432 121.811 Z M 391.432 121.811 L 393.432 121.811 L 393.432 123.811 L 391.432 123.811 L 391.432 121.811 Z M 393.432 121.811 L 395.432 121.811 L 395.432 123.811 L 393.432 123.811 L 393.432 121.811 Z M 395.432 121.811 L 397.432 121.811 L 397.432 123.811 L 395.432 123.811 L 395.432 121.811 Z M 399.432 121.811 L 401.432 121.811 L 401.432 123.811 L 399.432 123.811 L 399.432 121.811 Z M 405.432 121.811 L 407.432 121.811 L 407.432 123.811 L 405.432 123.811 L 405.432 121.811 Z M 407.432 121.811 L 409.432 121.811 L 409.432 123.811 L 407.432 123.811 L 407.432 121.811 Z M 411.432 121.811 L 413.432 121.811 L 413.432 123.811 L 411.432 123.811 L 411.432 121.811 Z M 413.432 121.811 L 415.432 121.811 L 415.432 123.811 L 413.432 123.811 L 413.432 121.811 Z M 421.432 121.811 L 423.432 121.811 L 423.432 123.811 L 421.432 123.811 L 421.432 121.811 Z M 387.432 123.811 L 389.432 123.811 L 389.432 125.811 L 387.432 125.811 L 387.432 123.811 Z M 399.432 123.811 L 401.432 123.811 L 401.432 125.811 L 399.432 125.811 L 399.432 123.811 Z M 409.432 123.811 L 411.432 123.811 L 411.432 125.811 L 409.432 125.811 L 409.432 123.811 Z M 411.432 123.811 L 413.432 123.811 L 413.432 125.811 L 411.432 125.811 L 411.432 123.811 Z M 417.432 123.811 L 419.432 123.811 L 419.432 125.811 L 417.432 125.811 L 417.432 123.811 Z M 421.432 123.811 L 423.432 123.811 L 423.432 125.811 L 421.432 125.811 L 421.432 123.811 Z M 387.432 125.811 L 389.432 125.811 L 389.432 127.811 L 387.432 127.811 L 387.432 125.811 Z M 389.432 125.811 L 391.432 125.811 L 391.432 127.811 L 389.432 127.811 L 389.432 125.811 Z M 391.432 125.811 L 393.432 125.811 L 393.432 127.811 L 391.432 127.811 L 391.432 125.811 Z M 393.432 125.811 L 395.432 125.811 L 395.432 127.811 L 393.432 127.811 L 393.432 125.811 Z M 395.432 125.811 L 397.432 125.811 L 397.432 127.811 L 395.432 127.811 L 395.432 125.811 Z M 397.432 125.811 L 399.432 125.811 L 399.432 127.811 L 397.432 127.811 L 397.432 125.811 Z M 399.432 125.811 L 401.432 125.811 L 401.432 127.811 L 399.432 127.811 L 399.432 125.811 Z M 403.432 125.811 L 405.432 125.811 L 405.432 127.811 L 403.432 127.811 L 403.432 125.811 Z M 409.432 125.811 L 411.432 125.811 L 411.432 127.811 L 409.432 127.811 L 409.432 125.811 Z M 415.432 125.811 L 417.432 125.811 L 417.432 127.811 L 415.432 127.811 L 415.432 125.811 Z M 417.432 125.811 L 419.432 125.811 L 419.432 127.811 L 417.432 127.811 L 417.432 125.811 Z M 419.432 125.811 L 421.432 125.811 L 421.432 127.811 L 419.432 127.811 L 419.432 125.811 Z M 423.432 125.811 L 425.432 125.811 L 425.432 127.811 L 423.432 127.811 L 423.432 125.811 Z M 427.432 125.811 L 429.432 125.811 L 429.432 127.811 L 427.432 127.811 L 427.432 125.811 Z" stroke="transparent" fill="black" style="stroke-width: 1;"/>
                                         </g>
                                         <text style="fill: rgb(51, 51, 51); font-family: Arial, sans-serif; white-space: pre; font-size: 16px;" x="20.094" y="60.503">Zum Beschreiben QR-Code scannen</text>
                                    </g>
                                 </svg>
                                """
                ),
                new TemplateSeed(
                        "room-booking",
                        "Raumbuchung Standard",
                        "Raumbuchung für 400x300 Displays",
                        400,
                        300,
                        """
                                <svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
                                    <rect width="400" height="300" fill="#ffffff"/>
                                    <text x="20" y="50" font-size="32" fill="#000000">{roomNumber}</text>
                                    <text x="20" y="90" font-size="18" fill="#000000">{roomType}</text>
                                </svg>
                                """
                )
        );

        for (TemplateSeed seed : seeds) {
            upsertTemplateType(seed);
            upsertTemplate(seed);
        }
    }

    private void upsertTemplate(TemplateSeed seed) {
        final String type = seed.templateType();
        final int w = seed.width();
        final int h = seed.height();
        final String svg = seed.svgContent().trim();

        templateRepository.findByTemplateTypeAndDisplayWidthAndDisplayHeight(type, w, h)
                .ifPresentOrElse(existing -> {
                    // update if needed
                    boolean needsUpdate =
                            forceOverwrite
                                    || !svg.equals(existing.getSvgContent())
                                    || !seed.name().equals(existing.getName())
                                    || !seed.description().equals(existing.getDescription());

                    if (needsUpdate) {
                        existing.setName(seed.name());
                        existing.setDescription(seed.description());
                        existing.setSvgContent(svg);
                        existing.setOrientation(existing.getOrientation() == null ? "landscape" : existing.getOrientation());
                        existing.setDisplayWidth(w);
                        existing.setDisplayHeight(h);
                        templateRepository.save(existing);
                        logger.info("Updated template '{}' ({}x{})", type, w, h);
                    } else {
                        logger.debug("Template '{}' ({}x{}) up-to-date. Skipping.", type, w, h);
                    }
                }, () -> {
                    createTemplate(seed);
                });
    }

    private void createTemplate(TemplateSeed seed) {
        try {
            TemplateDefinitionDTO dto = new TemplateDefinitionDTO();
            dto.setTemplateType(seed.templateType());
            dto.setName(seed.name());
            dto.setDescription(seed.description());
            dto.setDisplayWidth(seed.width());
            dto.setDisplayHeight(seed.height());
            dto.setSvgContent(seed.svgContent().trim());
            templateManagementService.createTemplate(dto);
            logger.info("Bootstrapped template '{}'", seed.templateType());
        } catch (Exception ex) {
            logger.error("Failed to bootstrap template '{}'", seed.templateType(), ex);
        }
    }

    private void upsertTemplateType(TemplateSeed seed) {
        TemplateType type = templateTypeRepository.findByTypeKey(seed.templateType()).orElseGet(TemplateType::new);
        boolean isNew = type.getId() == null;
        type.setTypeKey(seed.templateType());
        type.setLabel(seed.name());
        type.setDisplayWidth(seed.width());
        type.setDisplayHeight(seed.height());
        templateTypeRepository.save(type);
        if (isNew) {
            logger.info("Bootstrapped template type '{}'", seed.templateType());
        }
    }

    private record TemplateSeed(
            String templateType,
            String name,
            String description,
            int width,
            int height,
            String svgContent
    ) {
    }
}

